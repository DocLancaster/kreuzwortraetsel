<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ‚Äì R√§tsel-Stats</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-controls { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .admin-controls select, .admin-controls button { padding:8px 12px; font-size:14px; }
    .tables { display:grid; grid-template-columns: 1fr; gap:18px; }
    @media(min-width: 900px){ .tables { grid-template-columns: 1fr 1fr; } }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { padding:8px 10px; border-bottom:1px solid #e5e5e5; text-align:left; }
    th { background:#f7f7f7; position:sticky; top:0; z-index:1; }
    .num { text-align:right; font-variant-numeric: tabular-nums; }
    .search { margin-left:auto; }
    .muted { color:#666; font-size:12px; }

    .mini-charts { margin: 10px 0 18px; display:grid; grid-template-columns: 1fr; gap:12px; }
    .mini-charts .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:center; }
    .mini-charts .cardish { border:1px solid #e5e5e5; border-radius:10px; padding:10px 12px; background:#fff; }
    .mini-charts h4 { margin:0 0 6px; font-size:14px; font-weight:600; }
    .mini-charts select { padding:6px 8px; font-size:12px; }
    .spark-wrap { display:flex; align-items:center; gap:10px; }
    .spark-wrap canvas { width:100%; height:60px; display:block; }
    .spark-meta { min-width: 160px; }
    .spark-meta .big { font-size:18px; font-variant-numeric: tabular-nums; }
    @media (prefers-color-scheme: dark){
      .mini-charts .cardish { background:#0f1729; border-color:#1f2937; }
    }

    /* Force scrolling on admin page */
    html, body { overflow: auto !important; }

    /* Clickable rows */
    tbody tr.row-word { cursor: pointer; }
    tbody tr.row-word:hover { background: #f8fafc; }

    /* Modal styles */
    .modal[hidden] { display: none; }
    .modal { position: fixed; inset: 0; z-index: 10000; }
    .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.45); }
    .modal-panel {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: min(720px, calc(100vw - 32px)); max-height: calc(100vh - 32px);
      overflow: auto; background: #fff; border-radius: 16px; padding: 18px 18px 16px;
      box-shadow: 0 24px 80px rgba(0,0,0,.25);
    }
    .modal-panel h2 { margin: 0 0 6px; font-size: 20px; }
    .modal-close { position:absolute; right:10px; top:10px; border:none; background:#f3f4f6; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .detail-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px 14px; margin-top: 8px; font-size: 14px; }
    .detail-grid .label { color:#6b7280; }
    .detail-grid .value { font-weight:600; }
    @media (max-width: 720px){ .detail-grid{ grid-template-columns: 1fr; } }
    @media (prefers-color-scheme: dark){
      .modal-panel{ background:#0f1729; color:#e5e7eb; }
      .modal-close{ background:#111827; color:#e5e7eb; }
    }
  </style>
</head>
<body>
  <div class="back-to-menu" style="position:fixed;top:10px;left:10px;z-index:10000;">
    <button onclick="window.location.href='index.html'">‚Üê Hauptmen√º</button>
  </div>
  <div class="card" style="max-width: 980px;">
    <h1>Admin ‚Äì R√§tsel-Statistiken</h1>

    <p id="globalCounters" class="muted">Lade Z√§hler‚Ä¶</p>

    <div class="mini-charts">
      <div class="row">
        <div class="cardish">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <h4>Aktivit√§t ‚Äì Generiert</h4>
            <label class="muted">Zeitraum:
              <select id="tsDays">
                <option value="7">7 Tage</option>
                <option value="30">30 Tage</option>
              </select>
            </label>
          </div>
          <div class="spark-wrap">
            <div class="spark-meta">
              <div class="muted">Summe</div>
              <div id="genSum" class="big">‚Äì</div>
            </div>
            <canvas id="genSpark" width="600" height="100"></canvas>
          </div>
        </div>
        <div class="cardish">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <h4>Aktivit√§t ‚Äì Abgeschlossen</h4>
            <span class="muted">Letzte Tage wie links</span>
          </div>
          <div class="spark-wrap">
            <div class="spark-meta">
              <div class="muted">Summe</div>
              <div id="compSum" class="big">‚Äì</div>
            </div>
            <canvas id="compSpark" width="600" height="100"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="admin-controls">
      <label for="puzzleSel">Modus:</label>
      <select id="puzzleSel">
        <option value="classic">Classic</option>
        <option value="history">Geschichte-Special</option>
      </select>
      <button id="reloadBtn">Neu laden</button>
      <input id="search" class="search" type="search" placeholder="Suchen‚Ä¶ (Wort oder Hinweis)" />
    </div>

    <p class="muted" id="summary">Lade‚Ä¶</p>

    <div class="tables">
      <div>
        <h3>‚≠ê Top-Ratings (Bayes)</h3>
        <table id="tblRatings">
          <thead>
            <tr>
              <th>Wort</th>
              <th>Hinweis</th>
              <th class="num">√ò (Bayes)</th>
              <th class="num">Bewertungen</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <h3>üö© Top-Flags (nach Rate)</h3>
        <table id="tblFlags">
          <thead>
            <tr>
              <th>Wort</th>
              <th>Hinweis</th>
              <th class="num">Flags</th>
              <th class="num">Einblendungen</th>
              <th class="num">Rate</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <h3>üÜï Neu gemeldet (alle Flags)</h3>
        <table id="tblFlagsAll">
          <thead>
            <tr>
              <th>Wort</th>
              <th>Hinweis</th>
              <th class="num">Flags</th>
              <th class="num">Einblendungen</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div>
        <h3>üëÄ Meist angezeigt</h3>
        <table id="tblAppear">
          <thead>
            <tr>
              <th>Wort</th>
              <th>Hinweis</th>
              <th class="num">Einblendungen</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const puzzleConfig = {
      classic: { json: 'words.json', title: 'Kreuzwortr√§tsel' },
      history: { json: 'words.json', title: 'Geschichte-Special', filterTheme: 'history' }
    };

    const sel = document.getElementById('puzzleSel');
    const btn = document.getElementById('reloadBtn');
    const search = document.getElementById('search');
    const summary = document.getElementById('summary');

    const tsDaysEl = document.getElementById('tsDays');
    const genCanvas = document.getElementById('genSpark');
    const compCanvas = document.getElementById('compSpark');
    const genSumEl = document.getElementById('genSum');
    const compSumEl = document.getElementById('compSum');

    function drawSparkline(canvas, data){
      if (!canvas || !data) return;
      const dpr = window.devicePixelRatio || 1;
      const w = canvas.width, h = canvas.height;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,w,h);
      const n = data.length;
      if (!n) return;
      const max = Math.max(...data, 1);
      const min = Math.min(...data, 0);
      const padX = 6, padY = 6;
      const innerW = w - padX*2, innerH = h - padY*2;
      // line
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i=0; i<n; i++){
        const x = padX + (n===1 ? innerW/2 : (innerW * i/(n-1)));
        const v = data[i];
        const yNorm = max===min ? 0.5 : (v - min) / (max - min);
        const y = padY + innerH * (1 - yNorm);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    async function loadTimeseries(){
      try{
        const days = Number(tsDaysEl?.value || 7);
        const r = await fetch('/api/user-score', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ global: true, timeseries: true, days })
        });
        if (!r.ok) throw new Error('Timeseries failed');
        const data = await r.json();
        const ts = data?.timeseries;
        if (!ts) throw new Error('No timeseries');
        const gen = Array.isArray(ts.generated?.total) ? ts.generated.total : [];
        const comp = Array.isArray(ts.completed?.total) ? ts.completed.total : [];
        drawSparkline(genCanvas, gen);
        drawSparkline(compCanvas, comp);
        const sum = arr => arr.reduce((s,v)=>s+Number(v||0),0);
        genSumEl.textContent = sum(gen).toLocaleString('de-DE');
        compSumEl.textContent = sum(comp).toLocaleString('de-DE');
      } catch(e){
        console.warn(e);
        if (genSumEl) genSumEl.textContent = '‚Äî';
        if (compSumEl) compSumEl.textContent = '‚Äî';
      }
    }

    // --- stable IDs for words (fallback if JSON has no id) ---
    function fnv1a(str){
      let h = 0x811c9dc5;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
      }
      return h >>> 0;
    }
    function makeWordId(word){
      const base = (word || '').toUpperCase().trim();
      return 'w' + fnv1a(base).toString(36);
    }
    function ensureIds(list){
      return list.map(w => ({ ...w, id: w.id || makeWordId(w.word) }));
    }
    // --- end id helpers ---

    // Preselect from URL ?puzzle=...
    const params = new URLSearchParams(location.search);
    const initial = params.get('puzzle') || 'classic';
    sel.value = puzzleConfig[initial] ? initial : 'classic';
    btn.addEventListener('click', () => { loadGlobalCounters(); loadTimeseries(); load(sel.value); });
    async function loadGlobalCounters(){
      try{
        const r = await fetch('/api/user-score', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ global: true })
        });
        const el = document.getElementById('globalCounters');
        if (!el) return;
        if (!r.ok){
          el.textContent = 'Globale Z√§hler derzeit nicht verf√ºgbar.';
          return;
        }
        const data = await r.json();
        const g = data && data.global ? data.global : null;
        if (!g){
          el.textContent = 'Globale Z√§hler derzeit nicht verf√ºgbar.';
          return;
        }
        const gen = Number(g.generated || 0);
        const comp = Number(g.completed || 0);
        const cGen = Number(g.byPuzzle?.classic?.generated || 0);
        const cComp = Number(g.byPuzzle?.classic?.completed || 0);
        const hGen = Number(g.byPuzzle?.history?.generated || 0);
        const hComp = Number(g.byPuzzle?.history?.completed || 0);
        el.textContent =
          `Gesamt: ${gen.toLocaleString('de-DE')} generiert ¬∑ ${comp.toLocaleString('de-DE')} abgeschlossen ‚Äî ` +
          `Classic: ${cGen.toLocaleString('de-DE')} / ${cComp.toLocaleString('de-DE')} ‚Äî ` +
          `Geschichte: ${hGen.toLocaleString('de-DE')} / ${hComp.toLocaleString('de-DE')}`;
      }catch(_e){
        const el = document.getElementById('globalCounters');
        if (el) el.textContent = 'Globale Z√§hler derzeit nicht verf√ºgbar.';
      }
    }
    sel.addEventListener('change', () => load(sel.value));
    search.addEventListener('input', () => render(currentData));
    if (tsDaysEl) tsDaysEl.addEventListener('change', () => loadTimeseries());

    let wordsData = [];
    let metricsMap = {};
    let currentData = [];

    function findRowBy(word, id){
      if (id) { const r = currentData.find(x => x.id === id); if (r) return r; }
      return currentData.find(x => x.word === word);
    }

    // Mirror of placement priority (keep in sync with raetsel.html)
    function computePlacementScore(row){
      const len = (row.word || '').length;
      const lenNorm = Math.max(0, Math.min(1, (len - 3) / 9)); // 3..12 ‚Üí 0..1
      const ratingNorm = Math.max(0, Math.min(1, (row.bayesAvg || 0) / 5));
      const flagRate = Number(row.flagRate || 0);
      const flagPenalty = Math.max(0, Math.min(1, (flagRate - 0.03) / 0.12)); // 3% safe, 15% = full
      const appear = Number(row.appear || 0);
      const usagePenalty = appear > 0 ? (appear / (appear + 20)) : 0; // saturations curb repeat words

      const W = { base: 1.0, len: 0.6, rating: 1.2, flags: -1.0, usage: -0.8 };
      const score = W.base + W.len*lenNorm + W.rating*ratingNorm + W.flags*flagPenalty + W.usage*usagePenalty;

      return {
        score,
        breakdown: { lenNorm, ratingNorm, flagPenalty, usagePenalty, W }
      };
    }

    async function fetchJSON(path){
      const r = await fetch(path);
      if (!r.ok) throw new Error('fetch failed: '+ path);
      return r.json();
    }

    // Chunked metrics fetch to avoid URL length limits (ID-first)
    async function fetchMetricsChunked(puzzle, words, ids, chunkSize=300){
      const map = {};
      for (let i=0; i<words.length; i += chunkSize){
        const wslice = words.slice(i, i+chunkSize);
        const islice = Array.isArray(ids) ? ids.slice(i, i+chunkSize) : undefined;
        const body = { puzzle, words: wslice };
        if (islice && islice.length === wslice.length) body.ids = islice;
        const r = await fetch('/api/metrics', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        if (!r.ok){ console.warn('metrics failed', i, r.status); continue; }
        const part = await r.json();
        Object.assign(map, part);
      }
      return map;
    }

    function bayes(sum, count, prior=4.0, weight=10){
      return (prior*weight + sum) / (weight + count);
    }

    function fmt(n, digits=2){ return Number(n).toFixed(digits); }

    function render(data){
      const q = (search.value || '').trim().toLowerCase();
      let filtered = data;
      if (q){
        filtered = data.filter(row => row.word.toLowerCase().includes(q) || (row.clue || '').toLowerCase().includes(q));
      }

      // Ratings
      const topRatings = [...filtered]
        .sort((a,b) => b.bayesAvg - a.bayesAvg)
        .slice(0, 50);
      fillTable('tblRatings', topRatings, row => `
        <tr class="row-word" data-id="${row.id||''}" data-word="${row.word}" title="Details anzeigen">
          <td>${row.word}</td>
          <td>${row.clue || ''}</td>
          <td class="num">${fmt(row.bayesAvg,2)}</td>
          <td class="num">${row.ratingCount}</td>
        </tr>
      `);

      // Flags (by rate); require min appearances to reduce noise
      const minAppear = 5;
      const topFlags = filtered
        .filter(r => r.appear >= minAppear)
        .sort((a,b) => b.flagRate - a.flagRate)
        .slice(0, 50);
      fillTable('tblFlags', topFlags, row => `
        <tr class="row-word" data-id="${row.id||''}" data-word="${row.word}" title="Details anzeigen">
          <td>${row.word}</td>
          <td>${row.clue || ''}</td>
          <td class="num">${row.flags}</td>
          <td class="num">${row.appear}</td>
          <td class="num">${fmt(row.flagRate,3)}</td>
        </tr>
      `);

      // Neu gemeldet (alle Flags, ohne Mindest-Einblendungen)
      const flaggedAll = filtered
        .filter(r => (r.flags || 0) > 0)
        .sort((a,b) => b.flags - a.flags)
        .slice(0, 50);
      fillTable('tblFlagsAll', flaggedAll, row => `
        <tr class="row-word" data-id="${row.id||''}" data-word="${row.word}" title="Details anzeigen">
          <td>${row.word}</td>
          <td>${row.clue || ''}</td>
          <td class="num">${row.flags}</td>
          <td class="num">${row.appear}</td>
        </tr>
      `);

      // Appearances (numeric desc), with stable tie-breakers
      const topAppear = [...filtered]
        .sort((a,b) => (Number(b.appear||0) - Number(a.appear||0))
                        || (Number(b.flags||0) - Number(a.flags||0))
                        || a.word.localeCompare(b.word))
        .slice(0, 50);
      fillTable('tblAppear', topAppear, row => `
        <tr class="row-word" data-id="${row.id||''}" data-word="${row.word}" title="Details anzeigen">
          <td>${row.word}</td>
          <td>${row.clue || ''}</td>
          <td class="num">${row.appear}</td>
        </tr>
      `);

      // Summary
      const totalFlags = filtered.reduce((s,r)=>s+(r.flags||0),0);
      const totalAppear = filtered.reduce((s,r)=>s+(r.appear||0),0);
      const rated = filtered.filter(r => r.ratingCount>0);
      const avgOfAvg = rated.length ? (rated.reduce((s,r)=>s+r.avgRating,0)/rated.length) : 0;
      summary.textContent = `${filtered.length} W√∂rter ¬∑ Flags: ${totalFlags} ¬∑ Einblendungen: ${totalAppear} ¬∑ √ò Rating (nur bewertete): ${fmt(avgOfAvg,2)}`;
    }

    function fillTable(id, rows, rowTmpl){
      const tb = document.querySelector(`#${id} tbody`);
      tb.innerHTML = rows.map(rowTmpl).join('');
    }

    async function load(puzzle){
      try {
        const wordFile = puzzleConfig[puzzle]?.json || puzzleConfig.classic.json;
        wordsData = ensureIds(await fetchJSON(`/${wordFile}`));
        const unique = [];
        const seen = new Set();
        for (const it of wordsData){
          const key = it.id || it.word;
          if (!seen.has(key)) { seen.add(key); unique.push(it); }
        }
        const cfg = puzzleConfig[puzzle] || puzzleConfig.classic;
        let baseList = unique;
        if (cfg.filterTheme) {
          const th = cfg.filterTheme;
          baseList = unique.filter(it => Array.isArray(it.themes) && it.themes.includes(th));
        }
        const wordsOnly = baseList.map(w => w.word);
        const idsOnly   = baseList.map(w => w.id);
        metricsMap = await fetchMetricsChunked(puzzle, wordsOnly, idsOnly, 250);

        // combine
        currentData = baseList.map(it => {
          const m = metricsMap[it.word] || {};
          const sum = Number(m.ratingSum||0), count = Number(m.ratingCount||0);
          const avg = count ? sum / count : 0;
          const bayesAvg = bayes(sum, count);
          const appear = Number(m.appear||0);
          const flags = Number(m.flags||0);
          const flagRate = appear>0 ? flags/appear : 0;
          return {
            id: it.id,
            word: it.word,
            clue: it.clue,
            themes: Array.isArray(it.themes) ? it.themes : [],
            ratingSum: sum,
            ratingCount: count,
            avgRating: avg,
            bayesAvg,
            appear,
            flags,
            flagRate
          };
        });

        render(currentData);
        wireRowClicks();
      } catch (e){
        summary.textContent = 'Fehler beim Laden: ' + e.message;
        console.error(e);
      }
    }

    let _wired = false;
    function wireRowClicks(){
      if (_wired) return; _wired = true;
      document.addEventListener('click', (ev) => {
        const tr = ev.target.closest('tr.row-word');
        if (!tr) return;
        const id = tr.getAttribute('data-id') || undefined;
        const word = tr.getAttribute('data-word');
        const row = findRowBy(word, id);
        if (!row) return;
        const modal = document.getElementById('detailModal');
        const closeBtn = modal.querySelector('.modal-close');
        // Fill fields
        document.getElementById('detailTitle').textContent = row.word;
        document.getElementById('dWord').textContent = row.word;
        document.getElementById('dClue').textContent = row.clue || '';
        document.getElementById('dId').textContent = row.id || '‚Äî';
        document.getElementById('dThemes').textContent = (row.themes||[]).join(', ') || '‚Äî';
        document.getElementById('dLen').textContent = (row.word||'').length;
        document.getElementById('dAppear').textContent = Number(row.appear||0);
        document.getElementById('dFlags').textContent = Number(row.flags||0);
        document.getElementById('dFlagRate').textContent = fmt(Number(row.flagRate||0), 3);
        document.getElementById('dCount').textContent = Number(row.ratingCount||0);
        document.getElementById('dBayes').textContent = fmt(Number(row.bayesAvg||0), 2);
        const s = computePlacementScore(row);
        document.getElementById('dScore').textContent = fmt(s.score, 3);
        document.getElementById('dFormula').textContent = `1 + 0.6*lenNorm(${fmt(s.breakdown.lenNorm,2)}) + 1.2*rating(${fmt(s.breakdown.ratingNorm,2)}) - 1.0*flags(${fmt(s.breakdown.flagPenalty,2)}) - 0.8*usage(${fmt(s.breakdown.usagePenalty,2)})`;
        // Open
        modal.hidden = false;
        // close handlers
        const backdrop = modal.querySelector('.modal-backdrop');
        function close(){ modal.hidden = true; document.removeEventListener('keydown', onEsc); }
        function onEsc(e){ if (e.key === 'Escape') close(); }
        backdrop.addEventListener('click', close, { once:true });
        closeBtn.addEventListener('click', close, { once:true });
        document.addEventListener('keydown', onEsc, { once:true });
      });
    }

    // initial
    loadGlobalCounters();
    loadTimeseries();
    load(sel.value);
  </script>
</body>
  <div id="detailModal" class="modal" hidden>
    <div class="modal-backdrop"></div>
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <button class="modal-close" type="button" aria-label="Schlie√üen">‚úï</button>
      <h2 id="detailTitle">Wort-Details</h2>
      <div class="detail-grid">
        <div class="label">Wort</div><div class="value" id="dWord"></div>
        <div class="label">Hinweis</div><div class="value" id="dClue"></div>
        <div class="label">ID</div><div class="value" id="dId"></div>
        <div class="label">Themes</div><div class="value" id="dThemes"></div>
        <div class="label">L√§nge</div><div class="value" id="dLen"></div>
        <div class="label">Einblendungen</div><div class="value" id="dAppear"></div>
        <div class="label">Flags</div><div class="value" id="dFlags"></div>
        <div class="label">Flag-Rate</div><div class="value" id="dFlagRate"></div>
        <div class="label">Bewertungen</div><div class="value" id="dCount"></div>
        <div class="label">Rating-√ò (Bayes)</div><div class="value" id="dBayes"></div>
        <div class="label">Live-Score</div><div class="value" id="dScore"></div>
        <div class="label">Formel</div><div class="value" id="dFormula"></div>
      </div>
    </div>
  </div>
</html>